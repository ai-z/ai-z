name: Deploy APT repo (GitHub Pages)

on:
  workflow_run:
    workflows: ["Build APT repo (artifact)"]
    types:
      - completed
  workflow_dispatch:
    inputs:
      run_id:
        description: "Numeric run ID of a successful build run (from .../actions/runs/<id>). If you paste a tag like v0.1.1 here, it will be treated as a tag."
        required: false
        type: string
      tag:
        description: "Alternatively, a tag name like v0.1.1 (will find the successful build run for that tag)"
        required: false
        type: string

permissions:
  contents: read
  actions: read
  pages: write
  id-token: write

concurrency:
  group: pages-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Install tooling
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends jq unzip python3 python3-pip

      - name: Checkout (for README)
        uses: actions/checkout@v4

      - name: Download APT repo artifact
        env:
          GH_TOKEN: ${{ github.token }}
          RUN_ID_INPUT: ${{ inputs.run_id }}
          TAG_INPUT: ${{ inputs.tag }}
          RUN_ID_FROM_EVENT: ${{ github.event.workflow_run.id }}
        run: |
          set -euo pipefail

          resolve_run_id_from_tag() {
            local tag="$1"
            if [[ -z "$tag" ]]; then
              return 0
            fi
            # Resolve tag -> SHA (works for lightweight and annotated tags)
            local ref_json sha obj_type obj_sha
            if ! ref_json="$(gh api -H 'Accept: application/vnd.github+json' "repos/${GITHUB_REPOSITORY}/git/ref/tags/${tag}" 2>/dev/null)"; then
              # Common convenience: accept bare versions like 0.1.0 by trying v0.1.0
              if [[ "$tag" != v* ]]; then
                if ref_json="$(gh api -H 'Accept: application/vnd.github+json' "repos/${GITHUB_REPOSITORY}/git/ref/tags/v${tag}" 2>/dev/null)"; then
                  tag="v${tag}"
                else
                  return 2
                fi
              else
                return 2
              fi
            fi
            obj_type="$(echo "$ref_json" | jq -r '.object.type')"
            obj_sha="$(echo "$ref_json" | jq -r '.object.sha')"

            if [[ "$obj_type" == "tag" ]]; then
              sha="$(gh api -H 'Accept: application/vnd.github+json' "repos/${GITHUB_REPOSITORY}/git/tags/${obj_sha}" | jq -r '.object.sha')"
            else
              sha="$obj_sha"
            fi

            echo "Resolved tag '$tag' to SHA: $sha" >&2

            # Find the most recent successful run of the build workflow for that SHA.
            # (Don't rely exclusively on server-side filtering; fetch recent runs and filter locally.)
            local runs_json
            runs_json="$(gh api -H 'Accept: application/vnd.github+json' \
              "repos/${GITHUB_REPOSITORY}/actions/workflows/publish-apt-pages.yml/runs?per_page=50")"

            echo "$runs_json" | jq -r --arg sha "$sha" '.workflow_runs[]
              | select(.head_sha==$sha)
              | select(.conclusion=="success")
              | .id' | head -n 1
          }

          # Determine run id
          RUN_ID=""
          if [[ "${GITHUB_EVENT_NAME}" == "workflow_dispatch" ]]; then
            if [[ -n "${RUN_ID_INPUT:-}" ]]; then
              # Be forgiving: if the user pasted a tag into the run_id field, treat it as a tag.
              if [[ "$RUN_ID_INPUT" =~ ^[0-9]+$ ]]; then
                RUN_ID="$RUN_ID_INPUT"
              elif [[ -z "${TAG_INPUT:-}" ]]; then
                TAG_INPUT="$RUN_ID_INPUT"
              else
                echo "ERROR: Both run_id and tag provided, but run_id is not numeric: '$RUN_ID_INPUT'" >&2
                exit 1
              fi
            fi

            if [[ -z "${RUN_ID}" && -n "${TAG_INPUT:-}" ]]; then
              if ! RUN_ID="$(resolve_run_id_from_tag "$TAG_INPUT")"; then
                echo "ERROR: Tag not found on remote: '$TAG_INPUT'" >&2
                echo "Push it with: git push origin $TAG_INPUT" >&2
                exit 1
              fi
            fi
          else
            RUN_ID="$RUN_ID_FROM_EVENT"
          fi

          if [[ -z "${RUN_ID}" || "${RUN_ID}" == "null" ]]; then
            echo "ERROR: No build run id resolved." >&2
            echo "Provide either 'run_id' (numeric) or 'tag' (e.g. v0.1.1) when running this workflow manually." >&2
            echo "Tip: the 'tag' input also accepts bare versions like 0.1.0 (it will try v0.1.0)." >&2
            echo "Recent build workflow runs (id\tconclusion\thead_sha\tevent):" >&2
            gh api -H 'Accept: application/vnd.github+json' \
              "repos/${GITHUB_REPOSITORY}/actions/workflows/publish-apt-pages.yml/runs?per_page=10" \
              | jq -r '.workflow_runs[] | "\(.id)\t\(.conclusion)\t\(.head_sha)\t\(.event)"' >&2 || true
            exit 1
          fi

          if [[ ! "$RUN_ID" =~ ^[0-9]+$ ]]; then
            echo "ERROR: run id must be numeric; got: '$RUN_ID'" >&2
            echo "Tip: copy it from the URL of a successful build run: .../actions/runs/<id>" >&2
            exit 1
          fi

          echo "Fetching artifacts for run: $RUN_ID"
          json="$(gh api -H 'Accept: application/vnd.github+json' \
            "repos/${GITHUB_REPOSITORY}/actions/runs/${RUN_ID}/artifacts")"

          echo "Available artifacts (id\tname\texpired):"
          echo "$json" | jq -r '.artifacts[] | "\(.id)\t\(.name)\t\(.expired)"' || true

          artifact_id="$(echo "$json" | jq -r '.artifacts[] | select(.name=="apt-repo") | .id' | head -n 1)"
          if [[ -z "${artifact_id}" || "${artifact_id}" == "null" ]]; then
            echo "ERROR: Could not find artifact named 'apt-repo' for run $RUN_ID" >&2
            exit 1
          fi

          rm -rf artifact.zip artifact_tmp public
          gh api -H 'Accept: application/vnd.github+json' \
            "repos/${GITHUB_REPOSITORY}/actions/artifacts/${artifact_id}/zip" > artifact.zip
          unzip -q artifact.zip -d artifact_tmp

          # upload-artifact usually preserves the top-level folder name (e.g. 'public/').
          if [[ -d artifact_tmp/public ]]; then
            mv artifact_tmp/public public
          else
            mkdir -p public
            shopt -s dotglob
            mv artifact_tmp/* public/
          fi

          # Avoid any Jekyll processing; this is a static artifact deploy.
          touch public/.nojekyll

          echo "Published directory contents:" 
          find public -maxdepth 4 -type d -print | sed -n '1,120p'

      - name: Build homepage from README.md
        run: |
          set -euo pipefail

          python3 -m pip install --disable-pip-version-check --no-cache-dir markdown

          python3 - <<'PY'
          from __future__ import annotations
          from pathlib import Path
          import markdown

          readme = Path('README.md').read_text(encoding='utf-8')

          body = markdown.markdown(
              readme,
              extensions=[
                  'fenced_code',
                  'tables',
                  'toc',
              ],
          )

          html = f"""<!doctype html>
          <html lang=\"en\">
          <head>
            <meta charset=\"utf-8\" />
            <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\" />
            <title>ai-z</title>
            <link rel=\"icon\" href=\"favicon.ico\" type=\"image/x-icon\" />
            <link rel=\"shortcut icon\" href=\"favicon.ico\" type=\"image/x-icon\" />
            <style>
              :root {{ color-scheme: light dark; }}
              body {{ margin: 0; font: 16px/1.55 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, sans-serif; }}
              main {{ max-width: 920px; margin: 0 auto; padding: 32px 20px; }}
              h1,h2,h3 {{ line-height: 1.2; }}
              pre {{ overflow-x: auto; padding: 12px 14px; border-radius: 8px; background: rgba(127,127,127,0.12); }}
              code {{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; }}
              a {{ color: inherit; }}
            </style>
          </head>
          <body>
            <main>
              {body}
            </main>
          </body>
          </html>"""

          # Copy assets to public folder
          import shutil
          # Create assets directory in public
          Path('public/assets').mkdir(parents=True, exist_ok=True)
          
          # Copy favicon to root
          if Path('assets/favicon.ico').exists():
              shutil.copy('assets/favicon.ico', 'public/')
              print(f"Copied assets/favicon.ico to public/")
          
          # Copy logo to assets subfolder to preserve paths
          if Path('assets/logo.png').exists():
              shutil.copy('assets/logo.png', 'public/assets/')
              print(f"Copied assets/logo.png to public/assets/")

          # Copy screenshots used by README so image links work on Pages.
          if Path('screenshots').exists():
              shutil.copytree('screenshots', 'public/screenshots', dirs_exist_ok=True)
              print("Copied screenshots/ to public/screenshots/")

          out = Path('public/index.html')
          out.write_text(html, encoding='utf-8')
          print(f"Wrote {out} ({out.stat().st_size} bytes)")
          PY

      - name: Configure Pages
        uses: actions/configure-pages@v5

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Print install instructions
        run: |
          set -euo pipefail
          base_url='${{ steps.deployment.outputs.page_url }}'
          echo "Deployed GitHub Pages base URL: ${base_url}"
          echo "APT repo should be under: ${base_url}dists/stable"
          echo
          echo "Client install (unsigned):"
          echo "  echo \"deb [trusted=yes] ${base_url} stable main\" | sudo tee /etc/apt/sources.list.d/ai-z.list"
          echo "  sudo apt update"
          echo "  sudo apt install ai-z"
